<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CHINACNU 智能钢卷报价系统</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f4f6f8; }
    h1 { color: #2e7d32; text-align: center; }
    #chatbox { background: white; border-radius: 10px; padding: 20px; height: 500px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; }
    .user { color: blue; margin-top: 10px; }
    .bot { color: green; margin-bottom: 10px; }
    input[type="text"] { width: 100%; padding: 10px; font-size: 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>CHINACNU 智能钢卷报价系统</h1>
  <div id="chatbox"></div>
  <input type="text" id="userInput" placeholder="请输入内容，例如：0.4mm彩涂卷 锌层20g FOB天津港">

  <script>
    const apiKey = "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";
    const sheetId = "1L8RGRPI7BdIlDew99K7QIXU5f7llOLqWqskwXb1lms4";
    const apiKeySheet = "AIzaSyB-io6C9S0y5I6YXMi9TrDbAx8PkC2ReKo";
    const portKeywords = ["港口", "青岛", "天津", "送到", "fob"];

    const productMatch = [
      { key: "彩涂", value: "彩涂板(新增)" },
      { key: "有花镀锌 厚", value: "有花镀锌 厚板" },
      { key: "有花镀锌 薄", value: "有花镀锌 (薄板)带精包" },
      { key: "镀铝锌", value: "镀铝锌无耐指纹" },
      { key: "网纹", value: "网纹板" }
    ];

    function addMessage(role, text) {
      const chatbox = document.getElementById("chatbox");
      const msg = document.createElement("div");
      msg.className = role;
      msg.innerHTML = `<strong>${role === 'user' ? '客户' : '机器人'}:</strong> ${text}`;
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function extractParams(text) {
      const thickness = (text.match(/(\d+\.\d+)\s*mm/i) || [])[1];
      const zinc = (text.match(/(\d+)\s*(g|克)/i) || [])[1];
      const product = productMatch.find(p => text.includes(p.key))?.value;
      const port = portKeywords.some(k => text.toLowerCase().includes(k));
      return { product, thickness, zinc, port };
    }

    async function fetchSheetPrice(product, thickness) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/'${encodeURIComponent(product)}'!A1:Z100?key=${apiKeySheet}`;
      const res = await fetch(url);
      const data = await res.json();
      const headers = data.values[0];
      const rows = data.values.slice(1);
      const thicknessCol = headers.findIndex(h => h.includes("厚度"));
      const priceCol = headers.findIndex(h => h.includes("1000RMB"));
      let closest = null, minDiff = Infinity;
      for (const row of rows) {
        const t = parseFloat(row[thicknessCol]);
        if (!isNaN(t)) {
          const diff = Math.abs(t - parseFloat(thickness));
          if (diff < minDiff) {
            minDiff = diff;
            closest = row;
          }
        }
      }
      return parseFloat(closest?.[priceCol] || 0);
    }

    async function calculatePrice(params) {
      const rate = 7.2;
      const density = 7850;
      const volumePerTon = 1 / (density / 1000);
      const areaPerTon = volumePerTon / (parseFloat(params.thickness) / 1000);
      const zincCount = Math.max(0, parseFloat(params.zinc || 0) - 20);
      const zincCost = areaPerTon * zincCount * 0.025;
      const basePrice = await fetchSheetPrice(params.product, params.thickness);
      const exFactory = basePrice + zincCost;
      const fob = exFactory + 200 + (params.port ? 60 : 0);
      const taxRate = 0.935;
      return {
        exFactory,
        fob,
        exFactoryTax: exFactory / taxRate,
        fobTax: fob / taxRate,
        exFactoryUSD: exFactory / rate,
        fobUSD: fob / rate,
        fobTaxUSD: (fob / taxRate) / rate,
        zincCost
      };
    }

    async function askGPT(text) {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: "你是钢铁外贸专家，尽量准确报价并识别规格。" },
            { role: "user", content: text }
          ]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "🤖 抱歉，未能理解您的问题。";
    }

    document.getElementById("userInput").addEventListener("keypress", async function(e) {
      if (e.key === "Enter") {
        const input = this.value.trim();
        if (!input) return;
        addMessage("user", input);
        this.value = "";

        const params = extractParams(input);
        if (params.product && params.thickness) {
          const result = await calculatePrice(params);
          addMessage("bot", `📦 出厂价：¥${result.exFactory.toFixed(2)} / $${result.exFactoryUSD.toFixed(2)}<br>
          🧾 含税出厂价：¥${result.exFactoryTax.toFixed(2)}<br>
          🚢 FOB价：¥${result.fob.toFixed(2)} / $${result.fobUSD.toFixed(2)}<br>
          🧾 含税FOB价：¥${result.fobTax.toFixed(2)} / $${result.fobTaxUSD.toFixed(2)}<br>
          💡 锌层加价：¥${result.zincCost.toFixed(2)}${params.port ? '（含港口加价 $60）' : ''}`);
        } else {
          const gptAnswer = await askGPT(input);
          addMessage("bot", gptAnswer);
        }
      }
    });
  </script>
</body>
</html>
