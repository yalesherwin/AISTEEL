<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CHINACNU æ™ºèƒ½é’¢å·æŠ¥ä»·ç³»ç»Ÿ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: auto; background: #f4f6f8; }
    h1 { color: #2e7d32; text-align: center; }
    #chatbox { background: white; border-radius: 10px; padding: 20px; height: 500px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; }
    .user { color: blue; margin-top: 10px; }
    .bot { color: green; margin-bottom: 10px; }
    input[type="text"] { width: 100%; padding: 10px; font-size: 16px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>CHINACNU æ™ºèƒ½é’¢å·æŠ¥ä»·ç³»ç»Ÿ</h1>
  <div id="chatbox"></div>
  <input type="text" id="userInput" placeholder="è¯·è¾“å…¥å†…å®¹ï¼Œä¾‹å¦‚ï¼š0.4mmå½©æ¶‚å· é”Œå±‚20g FOBå¤©æ´¥æ¸¯">

  <script>
    const apiKey = "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";
    const sheetId = "1L8RGRPI7BdIlDew99K7QIXU5f7llOLqWqskwXb1lms4";
    const apiKeySheet = "AIzaSyB-io6C9S0y5I6YXMi9TrDbAx8PkC2ReKo";
    const portKeywords = ["æ¸¯å£", "é’å²›", "å¤©æ´¥", "é€åˆ°", "fob"];

    const productMatch = [
      { key: "å½©æ¶‚", value: "å½©æ¶‚æ¿(æ–°å¢)" },
      { key: "æœ‰èŠ±é•€é”Œ åš", value: "æœ‰èŠ±é•€é”Œ åšæ¿" },
      { key: "æœ‰èŠ±é•€é”Œ è–„", value: "æœ‰èŠ±é•€é”Œ (è–„æ¿)å¸¦ç²¾åŒ…" },
      { key: "é•€é“é”Œ", value: "é•€é“é”Œæ— è€æŒ‡çº¹" },
      { key: "ç½‘çº¹", value: "ç½‘çº¹æ¿" }
    ];

    function addMessage(role, text) {
      const chatbox = document.getElementById("chatbox");
      const msg = document.createElement("div");
      msg.className = role;
      msg.innerHTML = `<strong>${role === 'user' ? 'å®¢æˆ·' : 'æœºå™¨äºº'}:</strong> ${text}`;
      chatbox.appendChild(msg);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function extractParams(text) {
      const thickness = (text.match(/(\d+\.\d+)\s*mm/i) || [])[1];
      const zinc = (text.match(/(\d+)\s*(g|å…‹)/i) || [])[1];
      const product = productMatch.find(p => text.includes(p.key))?.value;
      const port = portKeywords.some(k => text.toLowerCase().includes(k));
      return { product, thickness, zinc, port };
    }

    async function fetchSheetPrice(product, thickness) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/'${encodeURIComponent(product)}'!A1:Z100?key=${apiKeySheet}`;
      const res = await fetch(url);
      const data = await res.json();
      const headers = data.values[0];
      const rows = data.values.slice(1);
      const thicknessCol = headers.findIndex(h => h.includes("åšåº¦"));
      const priceCol = headers.findIndex(h => h.includes("1000RMB"));
      let closest = null, minDiff = Infinity;
      for (const row of rows) {
        const t = parseFloat(row[thicknessCol]);
        if (!isNaN(t)) {
          const diff = Math.abs(t - parseFloat(thickness));
          if (diff < minDiff) {
            minDiff = diff;
            closest = row;
          }
        }
      }
      return parseFloat(closest?.[priceCol] || 0);
    }

    async function calculatePrice(params) {
      const rate = 7.2;
      const density = 7850;
      const volumePerTon = 1 / (density / 1000);
      const areaPerTon = volumePerTon / (parseFloat(params.thickness) / 1000);
      const zincCount = Math.max(0, parseFloat(params.zinc || 0) - 20);
      const zincCost = areaPerTon * zincCount * 0.025;
      const basePrice = await fetchSheetPrice(params.product, params.thickness);
      const exFactory = basePrice + zincCost;
      const fob = exFactory + 200 + (params.port ? 60 : 0);
      const taxRate = 0.935;
      return {
        exFactory,
        fob,
        exFactoryTax: exFactory / taxRate,
        fobTax: fob / taxRate,
        exFactoryUSD: exFactory / rate,
        fobUSD: fob / rate,
        fobTaxUSD: (fob / taxRate) / rate,
        zincCost
      };
    }

    async function askGPT(text) {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [
            { role: "system", content: "ä½ æ˜¯é’¢é“å¤–è´¸ä¸“å®¶ï¼Œå°½é‡å‡†ç¡®æŠ¥ä»·å¹¶è¯†åˆ«è§„æ ¼ã€‚" },
            { role: "user", content: text }
          ]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "ğŸ¤– æŠ±æ­‰ï¼Œæœªèƒ½ç†è§£æ‚¨çš„é—®é¢˜ã€‚";
    }

    document.getElementById("userInput").addEventListener("keypress", async function(e) {
      if (e.key === "Enter") {
        const input = this.value.trim();
        if (!input) return;
        addMessage("user", input);
        this.value = "";

        const params = extractParams(input);
        if (params.product && params.thickness) {
          const result = await calculatePrice(params);
          addMessage("bot", `ğŸ“¦ å‡ºå‚ä»·ï¼šÂ¥${result.exFactory.toFixed(2)} / $${result.exFactoryUSD.toFixed(2)}<br>
          ğŸ§¾ å«ç¨å‡ºå‚ä»·ï¼šÂ¥${result.exFactoryTax.toFixed(2)}<br>
          ğŸš¢ FOBä»·ï¼šÂ¥${result.fob.toFixed(2)} / $${result.fobUSD.toFixed(2)}<br>
          ğŸ§¾ å«ç¨FOBä»·ï¼šÂ¥${result.fobTax.toFixed(2)} / $${result.fobTaxUSD.toFixed(2)}<br>
          ğŸ’¡ é”Œå±‚åŠ ä»·ï¼šÂ¥${result.zincCost.toFixed(2)}${params.port ? 'ï¼ˆå«æ¸¯å£åŠ ä»· $60ï¼‰' : ''}`);
        } else {
          const gptAnswer = await askGPT(input);
          addMessage("bot", gptAnswer);
        }
      }
    });
  </script>
</body>
</html>
